<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <title>Project Wrap-Up &mdash; BITtailor @ Eclipse Open IoT Challenge</title>
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="/assets/prism.css">
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="/images/logo.jpg"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="BITtailor @ Eclipse Open IoT Challenge" />
    <meta name="title" content="Project Wrap-Up ">
    <link rel="canonical" href="http://incorporated.sendtoinc.com/2015/03/22/project-wrap-up/">
    
    
    <meta property="og:title" content="Project Wrap-Up "/>
    <meta property="og:url" content="http://incorporated.sendtoinc.com/2015/03/22/project-wrap-up/"/>
    



    <meta property="og:site_name" content="BITtailor @ Eclipse Open IoT Challenge">

</head>
<body>
<section class="site-nav">
    <header>
        <nav id="navigation">
            <a class="brand" href="/">
              <i class="fa fa-home fa-2x"></i>  <i class="fa fa-plug fa-rotate-45"></i> <i class="fa fa-cloud fa-2x"></i>
              <!-- <img src="/images/logo.jpg" alt="Inc"> -->
            </a>
            <a href="/edition/second/">2.0</a>
            <a href="/edition/first">1.0</a>
            <a href="http://iot.eclipse.org/open-iot-challenge/">@Eclipse</a>
            <a href="http://openiotchallenge.tumblr.com">@tumblr</a>
        </nav>
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                By <address><a rel="author" href="" title="BITtailor" target="_blank">BITtailor</a></address> &mdash;
                <time pubdate datetime="2015-22-March" title="March 22, 2015">March 22, 2015</time>
            </div>
            <h1 class="title">Project Wrap-Up</h1>
            <h2 class="subtitle">Creating a maker friendly DIY IoT home automation solution</h2>
        </header>

        <section>
            
<p>This is the final wrap-up post for my <a href="http://iot.eclipse.org/open-iot-challenge/">Eclipse Open IoT Challenge</a> project. I set out to build a maker friendly DIY IoT home automation solution, driven by my dissatisfaction with the humidifier control plugs I owned.</p>

<p>So as a proof of concept for my maker friendly DIY IoT home automation solution I built a simple <em>IoT air humidifier</em>:</p>

<!-- more -->

<iframe width="560" height="315" src="https://www.youtube.com/embed/9De5VZFZXVg" frameborder="0" allowfullscreen=""></iframe>

<h2 id="overview">Overview</h2>

<p><img src="/images/IoTOverviewSolution.png" alt="IoTOverviewSolution" /></p>

<p>This shows the overview of what I built which is nearly the same picture as in my <a href="/2015/01/25/project-idea/">project idea post</a>. I did not manage to build and setup everything I had in mind. Due to lack of time I skipped the connection to the various cloud services but I think it is simple to set them up trough configuring bridges on the <a href="http://mosquitto.org/">Mosquitto</a> broker or creating some forwarding flows in <a href="http://nodered.org/">Node-RED</a>.</p>

<p>All the source code for my project can be found on <a href="https://github.com/bittailor/BtIot"><i class="fa fa-github fa-2x"></i></a></p>

<p>But now to the details of what I built:</p>

<h2 id="the-sensor-node">The sensor node</h2>

<h3 id="hardware">Hardware</h3>

<p><img src="/images/SensorNodeFront.png" alt="SensorNodeFront" /> <img src="/images/SensorNodeRear.png" alt="SensorNodeRear" /></p>

<p>For the sensor node I created its own PCB that connects:</p>

<ul>
  <li>the <a href="http://www.atmel.com/devices/atmega328p.aspx">ATmega328</a> with the 8MHz crystal oscillator</li>
  <li>the <a href="https://www.nordicsemi.com/eng/Products/2.4GHz-RF/nRF24L01P">nRF24L01+</a> transceiver module</li>
  <li>a <a href="http://www.adafruit.com/product/385">DHT22</a> temperature and humidity sensor</li>
  <li>a <a href="https://www.adafruit.com/product/391">BMP085</a> barometric pressure and altitude sensor</li>
  <li>a <a href="http://www.mouser.com/ds/2/215/2468-285365.pdf">battery holder</a> for 2 AAA batteries</li>
  <li>a <a href="https://www.sparkfun.com/products/10967">NCP1402</a> 3.3V Step-Up power converter</li>
  <li>and a simple voltage divider to monitor the battery level</li>
</ul>

<h3 id="software">Software</h3>
<p>The sensor node software is built with the <a href="http://arduino.cc/">Arduino</a> programming platform. Besides the Arduino UNO core it uses the following libarries:</p>

<ul>
  <li><a href="http://playground.arduino.cc//Main/DHTLib">DHTLib</a>  to read the <a href="http://www.adafruit.com/product/385">DHT22</a> temperature and humidity sensor.</li>
  <li><a href="http://www.rocketscream.com/blog/2011/07/04/lightweight-low-power-arduino-library/">uA</a> a low power library for Arduino to enable sleeping on the sensor node.</li>
  <li><a href="https://github.com/bittailor/BtMqttSn#btmqttsn">BtMqttSn</a> my library for a MQTT-SN client communicating over a nRF24L01+ Transceiver.</li>
</ul>

<p>The code of the sensor node is <a href="https://github.com/bittailor/BtIot/blob/master/MqttSnSensorsNode/MqttSnSensorsNode.ino">here</a>. It publishes regularly the temperature and humidity with <a href="http://mqtt.org/new/wp-content/uploads/2009/06/MQTT-SN_spec_v1.2.pdf">MQTT-SN</a> over the wireless sensor network.</p>

<h2 id="the-actor-node">The actor node</h2>

<h3 id="hardware-1">Hardware</h3>

<p><img src="/images/ActorNode.png" alt="ActorNode" /></p>

<p>The actor node is currently just built as a prototype using a relay connected to an <a href="http://arduino.cc/en/Main/ArduinoBoardUno">Arduino Uno</a> board to switch a power line. The <a href="https://www.nordicsemi.com/eng/Products/2.4GHz-RF/nRF24L01P">nRF24L01+</a> is used to communicate over the wireless sensor network.</p>

<h3 id="software-1">Software</h3>

<p>Also the sensor node software is built with the <a href="http://arduino.cc/">Arduino</a> programming platform. The code of the actor node is <a href="https://github.com/bittailor/BtIot/blob/master/MqttSnActorNode/MqttSnActorNode.ino">here</a>. It uses <a href="http://mqtt.org/new/wp-content/uploads/2009/06/MQTT-SN_spec_v1.2.pdf">MQTT-SN</a> over the wireless sensor network to subscribes to a topic to control the relay.</p>

<h2 id="the-gateway">The gateway</h2>

<h3 id="hardware-2">Hardware</h3>

<p><img src="/images/GatewayImage.jpg" alt="GatewayImage" /></p>

<p>The gateway is built with a <a href="http://www.raspberrypi.org/">Raspberry Pi</a>. The <a href="https://www.nordicsemi.com/eng/Products/2.4GHz-RF/nRF24L01P">nRF24L01+</a> transceiver module is connected trough SPI.</p>

<h3 id="software-2">Software</h3>

<p>There are three main services on the gateway:</p>

<h4 id="the-mqtt-sn-gateway">The MQTT-SN gateway</h4>
<p>This is the application I built with the <a href="https://eclipse.org/kura/">Kura</a> framework. It <em>gateways</em> the MQTT-SN messages of the wireless sensor network to MQTT messages forwarded to the MQTT broker. The gateway is made up of three OSGI bundles:</p>

<ul>
  <li><strong><a href="https://github.com/bittailor/BtIot/tree/master/ch.bittailor.iot.core">ch.bittailor.iot.core</a></strong> Contains the implementation of the <a href="https://www.nordicsemi.com/eng/Products/2.4GHz-RF/nRF24L01P">nRF24L01+</a> based wireless sensor network and the MQTT-SN gateway using the wireless sensor network.</li>
  <li><strong><a href="https://github.com/bittailor/BtIot/tree/master/ch.bittailor.iot.wsn">ch.bittailor.iot.wsn</a></strong> Provides the wireless sensor network packet socket as OSGI service.</li>
  <li><strong><a href="https://github.com/bittailor/BtIot/tree/master/ch.bittailor.iot.mqttsn">ch.bittailor.iot.mqttsn</a></strong> Provides the MQTT-SN gateway as OSGI service.</li>
</ul>

<p>I planned to build a transparent gateway but since the Kura <a href="http://download.eclipse.org/kura/releases/1.1.0/docs/apidocs/org/eclipse/kura/cloud/CloudClient.html">CloudClient</a> already provides an aggregating MQTT service it is an aggregating gateway now.</p>

<p>The gateway currently supports:</p>

<ul>
  <li>Publish and subscribe with QoS 0.</li>
  <li>Sleeping clients.</li>
</ul>

<p>It does not yet provide:</p>

<ul>
  <li>QoS 1 und QoS 2.</li>
  <li>The search gateway feature, since the wireless sensor network does not yet provide a broadcasting.</li>
  <li>The last will feature.</li>
</ul>

<p>Furhter the wireless sensor network limits the maximum length of a MQTT-SN message to 29 octets.</p>

<h4 id="the-mqtt-broker">The MQTT broker</h4>
<p>Here I just installed the <a href="http://mosquitto.org/">Mosquitto</a> broker.</p>

<h4 id="node-red">Node-RED</h4>
<p>Installed node.js on the <a href="http://www.raspberrypi.org/">Raspberry Pi</a> and then <a href="http://nodered.org/">Node-RED</a> via <a href="https://www.npmjs.com/">npm</a>.</p>

<h2 id="the-wireless-sensor-network">The wireless sensor network</h2>
<p>The wireless sensor network is built with the <a href="https://www.nordicsemi.com/eng/Products/2.4GHz-RF/nRF24L01P">nRF24L01+</a> transceiver modules. The transceiver provides a link layer that features automatic acknowledgement and retransmissions of packets. On top of this a  tree based network layer, where each node has one parent and five child nodes, is implemented on the nodes and on the gateway. No fragmentation and reassembly is implemented in the network layers. Currently broadcasting and encryption are not implemented yet.</p>

<h2 id="lessons-learned-and-conclusion">Lessons learned and conclusion</h2>
<p>As always I completely underestimated the time I need to implement my ideas. I spent quite some time on understanding or fighting with Tycho and the hole build chain while working with Kura. It was nice that the Kura forum helped me with the (sometimes strange) questions I asked. I could even give a little bit back to the Kura community by my <a href="https://github.com/eclipse/kura/pull/30">pull request</a> that got meregd to Kura and fixed the SPI jdk.dio.policy.</p>

<p>I think the Kura framework provides a good platform to implement the MQTT-SN gateway. My MQTT-SN gateway is still in a prototype stage and missing some features. It is also too tightly coupled to my wireless sensor network implementation. I think this coupling could be removed and generalized so that other networks like UDP or ZigBee could be plugged in.</p>

<p>I choose to implement my own wireless sensor network based on the <a href="https://www.nordicsemi.com/eng/Products/2.4GHz-RF/nRF24L01P">nRF24L01+</a> transceiver modules because they are very inexpensive, are low power and I had a lot of them laying around. I’m not sure that it is the right way to continue, since it puts quite a burden on the sensor nodes to implement the network layer and it is still lacking some important features like encryption, broadcasting, fragmentation and reassembly.</p>

<p>I hope somebody enjoyed reading my posts. I for sure enjoyed working on my <a href="http://iot.eclipse.org/open-iot-challenge/">Eclipse Open IoT Challenge</a> project and I’m still eager to further <em>play</em> with IoT.</p>

            

        </section>

        <footer>
            <address>
               <img src="/images/avatar.png">
                <p>Written by <strong><a rel="author" href="https://twitter.com/bittailor_ch" title="" target="_blank">BITtailor</a></strong><br>
                <span class="muted">passion for the bits and bytes</span>
                </p>
            </address>

        </footer>

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'bittailoriotchallenge'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2016

        <nav>
            <a href="http://bittailor.ch/">BITtailor</a> &middot;
            <a href="/">Blog</a> &middot;
            <a href="http://iot.eclipse.org/open-iot-challenge/">@Eclipse</a>
            <a href="http://openiotchallenge.tumblr.com">@tumblr</a>
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/bittailor_ch" title="Follow on Twitter" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle-thin fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x"></i>
              </span>
            </a>
            
            
            <a href="http://github.com/bittailor" title="Fork on Github" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle-thin fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x"></i>
              </span>
            </a>
            
            <a href="/feed.xml" title="RSS Feed">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle-thin fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x"></i>
              </span>
            </a>

        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>







</body>
</html>
